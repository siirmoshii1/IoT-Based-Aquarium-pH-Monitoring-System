<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#020608"/>
<meta name="description" content="IoT Aquarium Monitoring System">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="logo.jpg">
<title>AquaStatus ‚Äî Master Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- CORE VARIABLES & RESET --- */
    :root {
        --bg-deep: #020608;
        --bg-glass: rgba(22, 38, 50, 0.85);
        --border-glass: rgba(142, 240, 255, 0.15);
        --primary: #00d4ff; --accent: #00ff9d;
        --danger: #ff4d4d; --warning: #ffcc00; --success: #00d26a;
        --text-main: #e6f7fb; --text-muted: #94a3b8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body { 
        font-family: 'Segoe UI', system-ui, sans-serif; 
        background: radial-gradient(circle at top right, #0c2a3d 0%, var(--bg-deep) 100%); 
        color: var(--text-main); 
        height: 100vh; 
        overflow: hidden; 
    }

    /* --- HEADER --- */
    header.topbar {
        height: 60px; display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; background: rgba(2, 6, 8, 0.8); border-bottom: 1px solid var(--border-glass);
        backdrop-filter: blur(12px); z-index: 100; position: sticky; top: 0;
    }
    .brand { font-weight: 800; color: var(--accent); font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .brand img { height: 32px; width: 32px; border-radius: 6px; object-fit: cover; }

    .status-badge { 
        font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 6px; 
        background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); transition: 0.3s;
    }
    .status-badge.online { border-color: var(--success); color: var(--success); box-shadow: 0 0 10px rgba(0, 210, 106, 0.2); }
    .status-badge.offline { border-color: var(--danger); color: var(--danger); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    /* --- MAIN LAYOUT --- */
    .main { display: grid; grid-template-columns: 1fr 380px; gap: 20px; padding: 20px; height: calc(100vh - 60px); overflow-y: auto; }
    .panel-col { display: flex; flex-direction: column; gap: 20px; }

    /* --- COMPONENTS --- */
    .glass-box {
        background: var(--bg-glass); border: 1px solid var(--border-glass); 
        border-radius: 16px; padding: 20px; backdrop-filter: blur(16px);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;
    }
    .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .box-title { font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .cards-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .sensor-card { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); text-align: center; position: relative; transition: 0.3s; }
    .sensor-card.error { border-color: var(--danger); background: rgba(255, 77, 77, 0.05); }
    .sensor-val { font-size: 24px; font-weight: 800; color: #fff; margin: 6px 0; }
    .sensor-label { font-size: 11px; color: var(--text-muted); }
    .status-pill { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.1); margin-top: 5px; opacity: 0.8; }

    .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; flex: 1; min-height: 300px; }
    .mini-chart { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; }
    .canvas-wrap { flex: 1; width: 100%; min-height: 0; position: relative; }

    .health-score-container { text-align: center; margin-bottom: 15px; }
    .score-circle { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto; border: 4px solid var(--success); display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.2); transition: border-color 0.5s; }
    .score-val { font-size: 32px; font-weight: 800; color: #fff; }
    .score-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }

    /* --- CONTROLS --- */
    .control-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider.danger { background-color: var(--danger); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- HISTORY LOGS --- */
    .rec-feed { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; max-height: 400px; padding-right: 5px; }
    .rec-card { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; border-left: 3px solid #555; animation: fadeIn 0.5s ease; }
    .rec-card.critical { border-left-color: var(--danger); background: rgba(255, 77, 77, 0.08); }
    .rec-card.warning { border-left-color: var(--warning); background: rgba(255, 180, 0, 0.08); }
    .rec-card.good { border-left-color: var(--success); background: rgba(0, 210, 106, 0.08); }
    .rec-header { font-size: 12px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .rec-body { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
    .rec-fix { display: block; margin-top: 8px; font-size: 11px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

    /* --- HISTORY TABLE & MODAL --- */
    .history-table { width: 100%; border-collapse: collapse; font-size: 11px; color: #ccc; }
    .history-table th { text-align: left; padding: 10px 6px; border-bottom: 1px solid var(--primary); color: var(--primary); font-weight:bold; position:sticky; top:0; background: #0f172a; }
    .history-table td { padding: 8px 6px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .history-scroll { max-height: 250px; overflow-y: auto; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); border-radius:8px; }
    .history-chart-wrapper { height: 150px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    
    .history-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .delete-select { background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); color: #ccc; padding: 8px; border-radius: 6px; font-size: 12px; outline: none; }
    .delete-select option { background: #020608; color: #fff; }

    /* --- MODALS & OVERLAYS --- */
    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(15px); transition: 0.3s; }
    .wizard-overlay.hidden { opacity: 0; pointer-events: none; }
    .wizard-box { background: #0f172a; border: 1px solid var(--primary); width: 700px; max-width: 90%; padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 0 50px rgba(0, 212, 255, 0.15); max-height: 90vh; overflow-y: auto; }
    .wiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 20px 0; max-height: 300px; overflow-y: auto; text-align: left; }
    .opt-label { display: block; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.2s; }
    input:checked + .opt-label { background: rgba(6,182,212,0.2); color: var(--accent); border: 1px solid var(--primary); }
    
    /* Shake Animation */
    @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    .shake { animation: shake 0.4s ease-in-out; border-color: var(--danger) !important; }

    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: #fff; transition: 0.2s; touch-action: manipulation; }
    .btn:hover { background: #22d3ee; }
    .btn-ghost { background: transparent; border: 1px solid #666; color: #aaa; }
    #pwaInstallBtn { display: none; background: var(--accent); color: #000; }

    /* --- SPLASH SCREEN --- */
    #splashScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020608; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s ease-in-out, visibility 1s; }
    #splashScreen.fade-out { opacity: 0; visibility: hidden; }
    .splash-logo { width: 120px; margin-bottom: 20px; animation: pulseLogo 2s infinite; border-radius: 15px; }
    @keyframes pulseLogo { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- RESPONSIVE --- */
    @media (max-width: 900px) {
        body { overflow-y: auto; height: auto; }
        .main { display: flex; flex-direction: column; height: auto; overflow: visible; padding-bottom: 40px; }
        .cards-grid { grid-template-columns: repeat(4, 1fr); }
        .charts-container { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
        .cards-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .charts-container { grid-template-columns: 1fr; }
        .mini-chart { height: 180px; }
        .brand { font-size: 16px; }
        .btn { padding: 12px 20px; width: 100%; margin-bottom: 5px; }
        .history-table { font-size: 10px; }
        .history-controls { flex-direction: column; align-items: flex-start; }
        .delete-select { width: 100%; margin-bottom: 5px; }
    }
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splashScreen">
    <img src="logo.jpg" class="splash-logo" alt="AquaStatus Logo">
    <h1 style="color:var(--accent); font-size:24px; letter-spacing:2px;">AquaStatus</h1>
    <p style="color:var(--text-muted); font-size:11px; margin-top:10px;">INITIALIZING SYSTEM...</p>
</div>

<!-- CREDITS MODAL -->
<div id="creditsModal" class="wizard-overlay hidden">
    <div class="wizard-box" style="width:450px;">
        <img src="logo.jpg" style="width:60px; margin-bottom:15px; border-radius:10px; box-shadow: 0 0 15px rgba(0,212,255,0.2);">
        <h2 style="color:var(--primary); margin-bottom:5px; font-size: 18px;">IoT Aquarium Monitor</h2>
        <p style="color:var(--text-muted); font-size:11px; letter-spacing:1px; margin-bottom:20px;">BSINFOTECH 4B | Capstone Project</p>
        <div style="text-align:left; background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05); font-size: 13px;">
            <p style="margin-bottom:8px;">üëë <strong>Leader:</strong> <span style="color:var(--accent)">Romias, John Mark A.</span></p>
            <p style="margin-bottom:8px;">üíª Acal, Kyla Jane M.</p>
            <p style="margin-bottom:8px;">üíª Garcia, Levin Rei V.</p>
            <p style="margin-bottom:8px;">üíª Bautista, Jennylyn T.</p>
            <p>üíª Tebia, Jowie D.</p>
        </div>
        <button class="btn" onclick="appFlow.closeCredits()">Launch Dashboard</button>
    </div>
</div>

<!-- SETUP WIZARD -->
<div id="setupWizard" class="wizard-overlay hidden">
    <div class="wizard-box" style="text-align:left; width:500px;">
        <div id="step1">
            <h2 style="color:var(--accent); font-size: 20px;">üê† Select Inhabitants</h2>
            <p style="color:#888; font-size:12px">We use this to calculate specific water parameters.</p>
            <div class="wiz-grid" id="fishGrid"></div>
            <div style="text-align:right; margin-top:15px;"><button class="btn" onclick="wizard.next(2)">Next Step</button></div>
        </div>
        <div id="step2" style="display:none">
            <h2 style="color:var(--accent); font-size: 20px;">ü™® Tank Elements</h2>
            <p style="color:#888; font-size:11px; margin-bottom:10px;">Select multiple elements that apply to your tank.</p>
            <div class="wiz-grid">
                <div><input type="checkbox" name="element" id="e1" value="Plants" hidden><label for="e1" class="opt-label">üåø Plants</label></div>
                <div><input type="checkbox" name="element" id="e2" value="Driftwood" hidden><label for="e2" class="opt-label">ü™µ Driftwood</label></div>
                <div><input type="checkbox" name="element" id="e3" value="CO2" hidden><label for="e3" class="opt-label">üí® CO2</label></div>
                <div><input type="checkbox" name="element" id="e4" value="Rocks" hidden><label for="e4" class="opt-label">ü™® Rocks</label></div>
                <div><input type="checkbox" name="element" id="e5" value="Coral" hidden><label for="e5" class="opt-label">üêö Coral</label></div>
                <div><input type="checkbox" name="element" id="e6" value="Sand" hidden><label for="e6" class="opt-label">üèñÔ∏è Sand</label></div>
                <div><input type="checkbox" name="element" id="e7" value="Soil" hidden><label for="e7" class="opt-label">üü§ Soil</label></div>
                <div><input type="checkbox" name="element" id="e8" value="Gravel" hidden><label for="e8" class="opt-label">‚ö™ Gravel</label></div>
            </div>
            <div style="display:flex; justify-content:space-between; gap:10px; margin-top:15px;">
                <button class="btn btn-ghost" onclick="wizard.next(1)">Back</button>
                <button class="btn" onclick="wizard.finish()">Initialize</button>
            </div>
        </div>
    </div>
</div>

<!-- HISTORY MODAL (FIREBASE + SD IMPORT) -->
<div id="historyModal" class="wizard-overlay hidden">
    <div class="wizard-box" style="width:700px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="color:var(--accent); font-size:18px;">üìã Data Log Manager</h2>
            <button style="background:none; border:none; color:#666; font-size:20px; cursor:pointer;" onclick="historyLog.close()">‚úï</button>
        </div>
        
        <!-- HISTORY GRAPH -->
        <div class="history-chart-wrapper">
            <canvas id="historyChart"></canvas>
        </div>

        <!-- CONTROLS: DELETE & IMPORT -->
        <div class="history-controls" style="flex-wrap:wrap; gap:10px;">
            <div style="display:flex; gap:5px; align-items:center;">
                <span style="font-size:11px; color:#888;">Manage:</span>
                <select id="deleteRange" class="delete-select">
                    <option value="hour">Delete Last Hour</option>
                    <option value="day">Delete Last 24h</option>
                    <option value="all">Clear All Logs</option>
                </select>
                <button class="btn btn-ghost" style="border-color:var(--danger); color:var(--danger); font-size:11px; padding:6px 10px;" onclick="historyLog.deleteSelected()">üóëÔ∏è Delete</button>
            </div>

            <!-- IMPORT BUTTONS -->
            <div style="display:flex; gap:5px;">
                <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="historyLog.importCSV(this)">
                <button class="btn btn-ghost" style="border-color:var(--primary); color:var(--primary); font-size:11px; padding:6px 10px;" onclick="document.getElementById('csvInput').click()">
                    üìÇ Import SD Log
                </button>
                <button class="btn btn-ghost" style="font-size:11px; padding:6px 10px;" onclick="historyLog.loadCloud()">‚òÅÔ∏è Cloud Refresh</button>
            </div>

            <button class="btn" style="padding:6px 20px; font-size:12px; margin-left:auto;" onclick="historyLog.close()">Close</button>
        </div>
        
        <div class="history-scroll">
            <table class="history-table">
                <thead><tr><th>Time</th><th>pH</th><th>Temp</th><th>TDS</th><th>Turb</th><th>Source</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        <p style="color:var(--text-muted); font-size:10px; margin-top:10px; opacity:0.7;">*Data source: Firebase Realtime Database or SD Card Import.</p>
    </div>
</div>

<header class="topbar blur-ui" id="uiHeader">
    <div class="brand">
        <img src="logo.jpg" alt="Logo">
        <div>AquaStatus <span style="font-size:9px; opacity:0.5; display:block; line-height:0.8;">FIREBASE</span></div>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
        <button id="pwaInstallBtn" class="btn" style="padding:6px 12px; font-size:11px; display:none;" onclick="installPWA()">‚¨áÔ∏è Install</button>
        <button class="btn btn-ghost" style="padding:6px 10px; font-size:18px;" onclick="historyLog.open()">üìã</button>
        <button class="btn btn-ghost" style="padding:6px 10px; font-size:18px;" onclick="wizard.edit()">‚öôÔ∏è</button>
        <div id="connBadge" class="status-badge"><div class="status-dot"></div> <span id="connText" style="display:none;">ON</span></div>
    </div>
</header>

<div class="main blur-ui" id="uiMain">
    
    <div class="panel-col">
        <div class="cards-grid">
            <div class="sensor-card" id="card-ph"><div class="sensor-label">pH Level</div><div class="sensor-val" id="val-ph">--</div><div class="status-pill" id="status-ph">...</div></div>
            <div class="sensor-card" id="card-temp"><div class="sensor-label">Temp (¬∞C)</div><div class="sensor-val" id="val-temp">--</div><div class="status-pill" id="status-temp">...</div></div>
            <div class="sensor-card" id="card-tds"><div class="sensor-label">TDS (ppm)</div><div class="sensor-val" id="val-tds">--</div><div class="status-pill" id="status-tds">...</div></div>
            <div class="sensor-card" id="card-turb"><div class="sensor-label">Clarity (%)</div><div class="sensor-val" id="val-turb">--</div><div class="status-pill" id="status-turb">...</div></div>
        </div>

        <div class="glass-box" style="flex:1">
            <div class="box-header"><div class="box-title">üìä Live Telemetry</div></div>
            <div class="charts-container">
                <div class="mini-chart"><div class="chart-header" style="color:#06b6d4; font-size:10px;">pH</div><div class="canvas-wrap"><canvas id="chartPH"></canvas></div></div>
                <div class="mini-chart"><div class="chart-header" style="color:#ff4d4d; font-size:10px;">TEMP</div><div class="canvas-wrap"><canvas id="chartTemp"></canvas></div></div>
                <div class="mini-chart"><div class="chart-header" style="color:#ffb400; font-size:10px;">TDS</div><div class="canvas-wrap"><canvas id="chartTDS"></canvas></div></div>
                <div class="mini-chart"><div class="chart-header" style="color:#b388ff; font-size:10px;">CLEAR</div><div class="canvas-wrap"><canvas id="chartTurb"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="panel-col">
        <div class="glass-box" style="border-color:rgba(255,77,77,0.2)">
            <div class="box-header"><div class="box-title" style="color:#ff8888">‚ö° Hardware Controls</div></div>
            <div class="control-row">
                <div style="font-size:13px; font-weight:bold">Master Power</div>
                <label class="switch"><input type="checkbox" id="btn-sys" onchange="blynk.set(PINS.sys, this.checked)"><span class="slider danger"></span></label>
            </div>
            <div class="control-row">
                <div style="font-size:13px; font-weight:bold">Buzzer Mute</div>
                <label class="switch"><input type="checkbox" id="btn-buz" onchange="blynk.set(PINS.buz, this.checked)"><span class="slider"></span></label>
            </div>
        </div>

        <div class="glass-box" style="flex:1; display:flex; flex-direction:column;">
            <div class="health-score-container">
                <div id="scoreCircle" class="score-circle">
                    <div id="healthScore" class="score-val">--</div>
                    <div class="score-label">Health</div>
                </div>
            </div>
            <div class="box-header">
                <div class="box-title">üß† Smart Analysis</div>
                <div style="font-size:9px; color:#666" id="lastAnalysisTime">...</div>
            </div>
            <div id="analysis-feed" class="rec-feed"><div class="rec-card"><div class="rec-body">Stabilizing... (10s)</div></div></div>
        </div>
    </div>
</div>

<!-- FIREBASE SDK V9 & LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, onValue, query, limitToLast, get, remove, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTa7zBIfKsMTJ3FMnPgG1Y_Bpq9mzufyk",
    authDomain: "aquastatus-6391e.firebaseapp.com",
    databaseURL: "https://aquastatus-6391e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "aquastatus-6391e",
    storageBucket: "aquastatus-6391e.firebasestorage.app",
    messagingSenderId: "245774969712",
    appId: "1:245774969712:web:e7e845e0be5c7112e0bdb5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --- 1. LIVE LISTENER (Watchdog Included) ---
  let watchdogTimer;
  
  const currentRef = ref(db, 'aquarium/current');
  onValue(currentRef, (snapshot) => {
      const data = snapshot.val();
      if(data) {
          // Reset Watchdog
          clearTimeout(watchdogTimer);
          setOnline(true);
          
          // Update UI
          window.updateUI(data.ph, data.temp, data.tds, data.turb);
          
          // Set Watchdog (15s)
          watchdogTimer = setTimeout(() => setOnline(false), 15000); // 15s without data = offline
      }
  });

  function setOnline(status) {
      const b = document.getElementById('connBadge');
      const t = document.getElementById('connText');
      t.style.display = 'inline';
      
      if(status) {
          b.className = 'status-badge online'; t.innerText = "ONLINE";
          document.getElementById('uiMain').classList.remove('offline-mode');
      } else {
          b.className = 'status-badge offline'; t.innerText = "OFFLINE";
          document.getElementById('uiMain').classList.add('offline-mode');
          window.updateUI(-1, -1, -1, -1); // Show error
      }
  }

  // --- 2. HISTORY FETCHER ---
  window.loadCloudHistory = async () => {
      const table = document.getElementById('historyBody');
      table.innerHTML = '<tr><td colspan="6" style="text-align:center">Loading Cloud Data...</td></tr>';
      
      try {
          // Query last 50 entries
          const q = query(ref(db, 'aquarium/history'), limitToLast(50));
          const snapshot = await get(q);
          
          if (snapshot.exists()) {
              const dataObj = snapshot.val();
              const dataArr = Object.values(dataObj);
              // Sort by timestamp
              dataArr.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
              
              window.renderHistoryTable(dataArr, "Cloud");
          } else {
              table.innerHTML = '<tr><td colspan="6" style="text-align:center">No Cloud Data Found</td></tr>';
          }
      } catch(e) {
          console.error(e);
          table.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red">Connection Failed</td></tr>';
      }
  };
  
  // Export function so standard JS can call it
  window.historyLog = {
     loadCloud: window.loadCloudHistory
  };

  window.firebaseLoaded = true;
</script>

<script>
// --- LEGACY JS (Charts, Logic, Wizard) ---
const FISH_DB = { "Goldfish": { minT: 18, maxT: 23, minPH: 7.0, maxPH: 8.0, maxTDS: 400 }, "Betta": { minT: 24, maxT: 28, minPH: 6.5, maxPH: 7.5, maxTDS: 250 }, "Guppy": { minT: 22, maxT: 28, minPH: 7.0, maxPH: 8.2, maxTDS: 500 }, "Discus": { minT: 28, maxT: 31, minPH: 6.0, maxPH: 7.0, maxTDS: 150 }, "Shrimp": { minT: 20, maxT: 26, minPH: 6.5, maxPH: 7.5, maxTDS: 250 }, "Tetra": { minT: 21, maxT: 27, minPH: 6.0, maxPH: 7.5, maxTDS: 200 } };
let appConfig = { limits: {}, elements: [], fish: [] };
let charts = {};
let lastAnalysis = 0;

// --- PWA ---
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; const btn = document.getElementById('pwaInstallBtn'); if(btn) btn.style.display = 'block'; });
async function installPWA() { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; if(outcome === 'accepted') document.getElementById('pwaInstallBtn').style.display = 'none'; }

// --- UI UPDATER ---
window.updateUI = (ph, temp, tds, turb) => {
    if (ph === -1) {
        document.getElementById('val-ph').innerText = "--";
        document.getElementById('val-temp').innerText = "--";
        document.getElementById('val-tds').innerText = "--";
        document.getElementById('val-turb').innerText = "--";
        document.querySelectorAll('.status-pill').forEach(p => { p.innerText = "OFFLINE"; p.style.background="#333"; p.style.color="#888"; });
        document.querySelectorAll('.sensor-card').forEach(c => c.className='sensor-card error');
        return;
    }

    document.getElementById('val-ph').innerText = parseFloat(ph).toFixed(2);
    document.getElementById('val-temp').innerText = parseFloat(temp).toFixed(1) + "¬∞";
    document.getElementById('val-tds').innerText = Math.floor(tds);
    document.getElementById('val-turb').innerText = Math.floor(turb) + "%";

    const updateChart = (key, val) => {
        const c = charts[key];
        if (!c) return;
        c.data.labels.push(''); 
        c.data.datasets[0].data.push(val);
        if(c.data.labels.length > 20) { c.data.labels.shift(); c.data.datasets[0].data.shift(); }
        c.update('none');
    };
    updateChart('ph', ph); updateChart('temp', temp); updateChart('tds', tds); updateChart('turb', turb);

    if(Date.now() - lastAnalysis > 10000) {
        analyzeStable(ph, temp, tds, turb);
        lastAnalysis = Date.now();
    }
};

// --- HISTORY LOGIC ---
const historyLog = {
    chart: null,
    open: () => {
        if(window.historyLog && window.historyLog.loadCloud) window.historyLog.loadCloud();
        document.getElementById('historyModal').classList.remove('hidden');
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.add('blur-ui'));
    },
    close: () => {
        document.getElementById('historyModal').classList.add('hidden');
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.remove('blur-ui'));
    },
    loadCloud: () => {
        if(window.historyLog && window.historyLog.loadCloud) window.historyLog.loadCloud();
    },
    importCSV: (input) => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            const feeds = [];
            for(let i=0; i<lines.length; i++) { 
                const cols = lines[i].split(',');
                if(cols.length >= 5 && !isNaN(cols[1])) {
                   feeds.push({ timestamp: cols[0], ph: cols[1], temp: cols[2], tds: cols[3], turb: cols[4] });
                }
            }
            window.renderHistoryTable(feeds, "SD Card");
        };
        reader.readAsText(file);
    },
    deleteSelected: () => {
        if(confirm("Clear current view? (Does not delete from cloud)")) {
            document.getElementById('historyBody').innerHTML = '';
            if(historyLog.chart) { 
                historyLog.chart.data.labels = []; 
                historyLog.chart.data.datasets.forEach((dataset) => { dataset.data = []; }); 
                historyLog.chart.update(); 
            }
        }
    }
};

// --- RENDER TABLE & CHART ---
window.renderHistoryTable = (dataArr, source) => {
    const tb = document.getElementById('historyBody');
    tb.innerHTML = '';
    const recent = dataArr.slice().reverse(); 
    
    recent.forEach(d => {
        tb.innerHTML += `<tr>
            <td style="color:#888; font-size:10px;">${d.timestamp}</td>
            <td>${parseFloat(d.ph).toFixed(1)}</td>
            <td>${parseFloat(d.temp).toFixed(1)}¬∞</td>
            <td>${d.tds}</td>
            <td>${d.turb}%</td>
            <td style="color:#00d4ff; font-size:10px;">${source}</td>
        </tr>`;
    });

    const chartData = recent.slice(0, 30).reverse();
    const ctx = document.getElementById('historyChart').getContext('2d');
    if(historyLog.chart) historyLog.chart.destroy();
    historyLog.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.timestamp.split(' ')[1] || ''),
            datasets: [
                { label: 'pH', data: chartData.map(d => d.ph), borderColor: '#00d4ff', tension: 0.4, yAxisID: 'y' },
                { label: 'Temp', data: chartData.map(d => d.temp), borderColor: '#ff4d4d', tension: 0.4, yAxisID: 'y' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: {display:false}, y: {grid:{color:'#333'}} } }
    });
};

// --- ANALYTICS ENGINE ---
function analyzeStable(ph, temp, tds, turb) {
    const L = appConfig.limits; const E = appConfig.elements;
    let items=[], score=100;

    const setPill=(id, cls, txt)=>{ 
        const el=document.getElementById('status-'+id); const c=document.getElementById('card-'+id);
        el.className=`status-pill`;
        el.style.background = cls==='good'?'rgba(0,255,157,0.1)':(cls==='warn'?'rgba(255,204,0,0.1)':'rgba(255,59,59,0.1)');
        el.style.color = cls==='good'?'var(--success)':(cls==='warn'?'var(--warning)':'var(--danger)');
        el.innerText=txt; 
        c.className = `sensor-card ${cls === 'good' ? '' : 'error'}`;
    };

    if(ph < L.minPH) { 
        let fix = E.includes("Driftwood") ? "Remove Driftwood." : "Add Buffer.";
        items.push({type:'critical', title:`Low pH`, rec:fix}); setPill('ph','bad','ACIDIC'); score-=20; 
    } else if(ph > L.maxPH) { 
        items.push({type:'warning', title:`High pH`, rec:"Add Peat."}); setPill('ph','warn','ALKALINE'); score-=10; 
    } else setPill('ph','good','OPTIMAL');

    if(temp < L.minT) { items.push({type:'critical', title:`Low Temp`, rec:"Check Heater."}); setPill('temp','bad','COLD'); score-=30; }
    else if(temp > L.maxT) { items.push({type:'critical', title:`High Temp`, rec:"Cool Down."}); setPill('temp','bad','HOT'); score-=30; }
    else setPill('temp','good','OPTIMAL');

    if(turb < 20) { items.push({type:'critical', title:`Cloudy`, rec:"Check Filter."}); setPill('turb','bad','DIRTY'); score-=15; }
    else setPill('turb','good','CLEAR');

    const feed=document.getElementById('analysis-feed');
    if(!items.length) feed.innerHTML=`<div class="rec-card good"><div class="rec-header">‚úÖ Stable</div><div class="rec-body">Optimal conditions.</div></div>`;
    else feed.innerHTML=items.map(i=>`<div class="rec-card ${i.type}"><div class="rec-header">${i.title}</div><div class="rec-body">${i.rec}</div></div>`).join('');

    if(score<0) score=0; 
    document.getElementById('healthScore').innerText=Math.floor(score)+"%";
    const ring = document.getElementById('scoreCircle');
    ring.style.borderColor = score > 80 ? 'var(--success)' : (score > 50 ? 'var(--warning)' : 'var(--danger)');
    document.getElementById('lastAnalysisTime').innerText="Updated: " + new Date().toLocaleTimeString();
}

// --- INITIALIZATION ---
const wizard = {
    init: () => {
        const g = document.getElementById('fishGrid'); g.innerHTML = '';
        Object.keys(FISH_DB).forEach(f => { g.innerHTML += `<div><input type="radio" name="fish" id="f_${f}" value="${f}" hidden><label for="f_${f}" class="opt-label">üêü ${f}</label></div>`; });
    },
    edit: () => {
        document.getElementById('setupWizard').classList.remove('hidden'); 
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.add('blur-ui'));
        wizard.next(1);
    },
    next: (s) => { 
        if(s === 2) {
            if(!document.querySelector('input[name="fish"]:checked')) {
                document.getElementById('step1').classList.add('shake');
                setTimeout(()=>document.getElementById('step1').classList.remove('shake'), 500);
                return; 
            }
        }
        document.getElementById('step1').style.display=s===1?'block':'none'; 
        document.getElementById('step2').style.display=s===2?'block':'none'; 
    },
    finish: () => {
        // Logic allows multiple selections for elements as previously requested
        // But to keep it simple per this request, I kept radio buttons for single selection
        // If multiple selection is needed, change input type="checkbox" in HTML
        if(!document.querySelector('input[name="element"]:checked')) {
            document.getElementById('step2').classList.add('shake');
            setTimeout(()=>document.getElementById('step2').classList.remove('shake'), 500);
            return; 
        }

        const fish = [document.querySelector('input[name="fish"]:checked').value];
        // For multiple elements, we would use querySelectorAll and loop
        // Here we stick to the single selection logic requested
        const elem = [];
        document.querySelectorAll('input[name="element"]:checked').forEach(cb => {
            elem.push(cb.value);
        });
        
        // Calculate Limits
        let minT=0, maxT=100, minPH=0, maxPH=14, maxTDS=1000;
        fish.forEach(f => { 
            const d = FISH_DB[f]; 
            if(d.minT > minT) minT=d.minT; if(d.maxT < maxT) maxT=d.maxT;
            if(d.minPH > minPH) minPH=d.minPH; if(d.maxPH < maxPH) maxPH=d.maxPH;
        });
        if(elem.includes("Driftwood")) minPH -= 0.3;
        
        appConfig = { limits:{minT,maxT,minPH,maxPH,maxTDS}, elements:elem, fish:fish };
        localStorage.setItem('aqua_conf', JSON.stringify(appConfig));
        document.getElementById('setupWizard').classList.add('hidden');
        appFlow.launch();
    }
};

const appFlow = {
    start: () => {
        setTimeout(() => {
            document.getElementById('splashScreen').style.opacity = 0;
            setTimeout(() => { 
                document.getElementById('splashScreen').style.display='none'; 
                document.getElementById('creditsModal').classList.remove('hidden'); 
            }, 1000);
        }, 2500);
    },
    closeCredits: () => {
        document.getElementById('creditsModal').classList.add('hidden');
        const saved = JSON.parse(localStorage.getItem('aqua_conf'));
        if(saved) { appConfig=saved; appFlow.launch(); } 
        else { document.getElementById('setupWizard').classList.remove('hidden'); wizard.next(1); }
        
        if('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
    },
    launch: () => {
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.remove('blur-ui'));
        initCharts();
    }
};

function initCharts() {
    const opts = { responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#333'}}} , elements:{point:{radius:0}} };
    const make = (id, c) => new Chart(document.getElementById(id), {type:'line', data:{labels:[], datasets:[{borderColor:c, backgroundColor:c+'15', fill:true, data:[]}]}, options:opts});
    charts.ph = make('chartPH', '#00d4ff'); 
    charts.temp = make('chartTemp', '#ff4d4d'); 
    charts.tds = make('chartTDS', '#ffcc00'); 
    charts.turb = make('chartTurb', '#b388ff');
}

window.onload = () => { wizard.init(); appFlow.start(); };
</script>
</body>
</html>
