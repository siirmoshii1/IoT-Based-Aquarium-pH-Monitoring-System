<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="description" content="IoT Aquarium Monitoring System">
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#020608">

<link rel="apple-touch-icon" href="logo.jpg">
<title>AquaStatus ‚Äî Master Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --bg-deep: #020608;
        --bg-glass: rgba(22, 38, 50, 0.85);
        --border-glass: rgba(142, 240, 255, 0.15);
        --primary: #00d4ff; --accent: #00ff9d;
        --danger: #ff4d4d; --warning: #ffcc00; --success: #00d26a;
        --text-main: #e6f7fb; --text-muted: #94a3b8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body { 
        font-family: 'Segoe UI', system-ui, sans-serif; 
        background: radial-gradient(circle at top right, #0c2a3d 0%, var(--bg-deep) 100%); 
        color: var(--text-main); 
        height: 100vh; 
        overflow: hidden; 
    }

    /* --- TOPBAR --- */
    header.topbar {
        height: 60px; display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; background: rgba(2, 6, 8, 0.8); border-bottom: 1px solid var(--border-glass);
        backdrop-filter: blur(12px); z-index: 100; position: sticky; top: 0;
    }
    .brand { font-weight: 800; color: var(--accent); font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .brand img { height: 32px; width: 32px; border-radius: 6px; object-fit: cover; }

    .status-badge { 
        font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 6px; 
        background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass);
    }
    .status-badge.online { border-color: var(--success); color: var(--success); }
    .status-badge.offline { border-color: var(--danger); color: var(--danger); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    /* --- MAIN LAYOUT --- */
    .main { 
        display: grid; 
        grid-template-columns: 1fr 380px; 
        gap: 20px; 
        padding: 20px; 
        height: calc(100vh - 60px); 
        overflow-y: auto; 
    }

    .panel-col { display: flex; flex-direction: column; gap: 20px; }

    /* --- COMPONENTS --- */
    .glass-box {
        background: var(--bg-glass); border: 1px solid var(--border-glass); 
        border-radius: 16px; padding: 20px; backdrop-filter: blur(16px);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;
    }
    .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .box-title { font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    /* --- SENSOR CARDS --- */
    .cards-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .sensor-card { 
        background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px; 
        border: 1px solid rgba(255,255,255,0.05); text-align: center; position: relative; transition: 0.3s;
    }
    .sensor-card.error { border-color: var(--danger); background: rgba(255, 77, 77, 0.05); }
    .sensor-val { font-size: 24px; font-weight: 800; color: #fff; margin: 6px 0; }
    .sensor-label { font-size: 11px; color: var(--text-muted); }
    .status-pill { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.1); margin-top: 5px; opacity: 0.8; }

    /* --- CHARTS --- */
    .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; flex: 1; min-height: 300px; }
    .mini-chart { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; }
    .canvas-wrap { flex: 1; width: 100%; min-height: 0; position: relative; }

    /* --- HEALTH SCORE --- */
    .health-score-container { text-align: center; margin-bottom: 15px; }
    .score-circle {
        width: 100px; height: 100px; border-radius: 50%; margin: 0 auto;
        border: 4px solid var(--success); display: flex; flex-direction: column;
        justify-content: center; align-items: center; background: rgba(0,0,0,0.2);
        transition: border-color 0.5s;
    }
    .score-val { font-size: 32px; font-weight: 800; color: #fff; }
    .score-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }

    /* --- CONTROLS --- */
    .control-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider.danger { background-color: var(--danger); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- HISTORY & ANALYSIS LISTS --- */
    .rec-feed { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; max-height: 400px; padding-right: 5px; }
    
    .rec-card { 
        background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; border-left: 3px solid #555; 
        animation: fadeIn 0.5s ease; 
    }
    .rec-card.critical { border-left-color: var(--danger); background: rgba(255, 77, 77, 0.08); }
    .rec-card.warning { border-left-color: var(--warning); background: rgba(255, 180, 0, 0.08); }
    .rec-card.good { border-left-color: var(--success); background: rgba(0, 210, 106, 0.08); }
    
    .rec-header { font-size: 12px; font-weight: 700; color: #fff; margin-bottom: 6px; display: flex; justify-content: space-between; }
    .rec-body { font-size: 12px; color: #ccc; line-height: 1.5; }
    .rec-fix { display: block; margin-top: 8px; font-size: 11px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

    .history-table { width: 100%; border-collapse: collapse; font-size: 12px; color: #ccc; }
    .history-table th { text-align: left; padding: 8px; border-bottom: 1px solid var(--primary); color: var(--primary); }
    .history-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .history-scroll { max-height: 300px; overflow-y: auto; margin-top: 10px; }

    /* --- MODALS & OVERLAYS --- */
    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(15px); transition: 0.3s; }
    .wizard-overlay.hidden { opacity: 0; pointer-events: none; }
    .wizard-box { background: #0f172a; border: 1px solid var(--primary); width: 500px; max-width: 90%; padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 0 50px rgba(0, 212, 255, 0.15); max-height: 90vh; overflow-y: auto; }
    .wiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 20px 0; max-height: 300px; overflow-y: auto; text-align: left; }
    .opt-label { display: block; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.2s; }
    .opt-label:active { transform: scale(0.98); }
    input:checked + .opt-label { background: rgba(6,182,212,0.2); color: var(--accent); border: 1px solid var(--primary); }

    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: #fff; transition: 0.2s; touch-action: manipulation; }
    .btn:hover { background: #22d3ee; }
    .btn-ghost { background: transparent; border: 1px solid #666; color: #aaa; }
    
    /* Install Button Style */
    #pwaInstallBtn { display: none; background: var(--accent); color: #000; }

    /* --- SPLASH SCREEN --- */
    #splashScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020608; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s ease-in-out, visibility 1s; }
    #splashScreen.fade-out { opacity: 0; visibility: hidden; }
    .splash-logo { width: 120px; margin-bottom: 20px; animation: pulseLogo 2s infinite; border-radius: 15px; }
    @keyframes pulseLogo { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- RESPONSIVE --- */
    @media (max-width: 900px) {
        body { overflow-y: auto; height: auto; }
        .main { display: flex; flex-direction: column; height: auto; overflow: visible; padding-bottom: 40px; }
        .cards-grid { grid-template-columns: repeat(4, 1fr); }
        .charts-container { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
        .cards-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .charts-container { grid-template-columns: 1fr; }
        .mini-chart { height: 180px; }
        .brand { font-size: 16px; }
        .btn { padding: 12px 20px; width: 100%; margin-bottom: 5px; }
        .history-table { font-size: 10px; }
    }
</style>
</head>
<body>

<div id="splashScreen">
    <img src="logo.jpg" class="splash-logo" alt="AquaStatus Logo">
    <h1 style="color:var(--accent); font-size:24px; letter-spacing:2px;">AquaStatus</h1>
    <p style="color:var(--text-muted); font-size:11px; margin-top:10px; letter-spacing: 1px;">INITIALIZING SYSTEM...</p>
</div>

<div id="creditsModal" class="wizard-overlay hidden">
    <div class="wizard-box">
        <img src="logo.jpg" style="width:60px; margin-bottom:15px; border-radius:10px; box-shadow: 0 0 15px rgba(0,212,255,0.2);">
        <h2 style="color:var(--primary); margin-bottom:5px; font-size: 18px;">IoT Aquarium Monitor</h2>
        <p style="color:var(--text-muted); font-size:11px; letter-spacing:1px; margin-bottom:20px;">BSINFOTECH 4B | IT Elective 5 Project</p>
        <div style="text-align:left; background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05); font-size: 13px;">
            <p style="margin-bottom:8px;">üëë <strong>Leader:</strong> <span style="color:var(--accent)">Romias, John Mark A.</span></p>
            <p style="margin-bottom:8px;">üíª Acal, Kyla Jane M.</p>
            <p style="margin-bottom:8px;">üíª Garcia, Levin Rei V.</p>
            <p style="margin-bottom:8px;">üíª Bautista, Jennylyn T.</p>
            <p>üíª Tebia, Jowie D.</p>
        </div>
        <button class="btn" onclick="appFlow.closeCredits()">Launch Dashboard</button>
    </div>
</div>

<div id="setupWizard" class="wizard-overlay hidden">
    <div class="wizard-box" style="text-align:left;">
        <div id="step1">
            <h2 style="color:var(--accent); font-size: 20px;">üê† Select Inhabitants</h2>
            <p style="color:#888; font-size:12px">We use this to calculate specific water parameters.</p>
            <div class="wiz-grid" id="fishGrid"></div>
            <div style="text-align:right; margin-top:15px;"><button class="btn" onclick="wizard.next(2)">Next Step</button></div>
        </div>
        <div id="step2" style="display:none">
            <h2 style="color:var(--accent); font-size: 20px;">ü™® Tank Elements</h2>
            <div class="wiz-grid">
                <div><input type="checkbox" id="e1" value="Plants" hidden><label for="e1" class="opt-label">üåø Plants</label></div>
                <div><input type="checkbox" id="e2" value="Driftwood" hidden><label for="e2" class="opt-label">ü™µ Driftwood</label></div>
                <div><input type="checkbox" id="e3" value="CO2" hidden><label for="e3" class="opt-label">üí® CO2</label></div>
                <div><input type="checkbox" id="e4" value="Rocks" hidden><label for="e4" class="opt-label">ü™® Rocks</label></div>
                <div><input type="checkbox" id="e5" value="Coral" hidden><label for="e5" class="opt-label">üêö Coral</label></div>
                <div><input type="checkbox" id="e6" value="Sand" hidden><label for="e6" class="opt-label">üèñÔ∏è Sand</label></div>
                <div><input type="checkbox" id="e7" value="Soil" hidden><label for="e7" class="opt-label">üü§ Soil</label></div>
                <div><input type="checkbox" id="e8" value="Gravel" hidden><label for="e8" class="opt-label">‚ö™ Gravel</label></div>
            </div>
            <div style="display:flex; justify-content:space-between; gap:10px; margin-top:15px;">
                <button class="btn btn-ghost" onclick="wizard.next(1)">Back</button>
                <button class="btn" onclick="wizard.finish()">Initialize</button>
            </div>
        </div>
    </div>
</div>

<div id="historyModal" class="wizard-overlay hidden">
    <div class="wizard-box" style="width:600px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="color:var(--accent); font-size:18px;">Data Log</h2>
            <button style="background:none; border:none; color:#666; font-size:20px; cursor:pointer;" onclick="historyLog.close()">‚úï</button>
        </div>
        <p style="color:var(--text-muted); font-size:11px; margin-bottom:15px;">
            Data stored locally. Gaps indicate times when the dashboard was closed.
        </p>
        <div class="history-scroll">
            <table class="history-table">
                <thead><tr><th>Date</th><th>Time</th><th>pH</th><th>Temp</th><th>TDS</th><th>Turb</th><th>Health</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-ghost" style="border-color:var(--danger); color:var(--danger); font-size:12px;" onclick="historyLog.clear()">üóëÔ∏è Clear All</button>
            <button class="btn" style="flex:1;" onclick="historyLog.close()">Close Log</button>
        </div>
    </div>
</div>

<header class="topbar blur-ui" id="uiHeader">
    <div class="brand">
        <img src="logo.jpg" alt="Logo">
        <div>AquaStatus <span style="font-size:9px; opacity:0.5; display:block; line-height:0.8;">PRO</span></div>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
        <!-- <button id="pwaInstallBtn" class="btn" style="padding:6px 12px; font-size:11px; display:none;" onclick="installPWA()">Install</button> -->
        <button class="btn btn-ghost" style="padding:6px 10px; font-size:18px;" onclick="historyLog.open()">History</button>
        <button class="btn btn-ghost" style="padding:6px 10px; font-size:18px;" onclick="wizard.edit()">Setting</button>
        <div id="connBadge" class="status-badge"><div class="status-dot"></div> <span id="connText" style="display:none;">ON</span></div>
    </div>
</header>

<div class="main blur-ui" id="uiMain">
    
    <div class="panel-col">
        <div class="cards-grid">
            <div class="sensor-card" id="card-ph"><div class="sensor-label">pH Level</div><div class="sensor-val" id="val-ph">--</div><div class="status-pill" id="status-ph">...</div></div>
            <div class="sensor-card" id="card-temp"><div class="sensor-label">Temp (¬∞C)</div><div class="sensor-val" id="val-temp">--</div><div class="status-pill" id="status-temp">...</div></div>
            <div class="sensor-card" id="card-tds"><div class="sensor-label">TDS (ppm)</div><div class="sensor-val" id="val-tds">--</div><div class="status-pill" id="status-tds">...</div></div>
            <div class="sensor-card" id="card-turb"><div class="sensor-label">Clarity (%)</div><div class="sensor-val" id="val-turb">--</div><div class="status-pill" id="status-turb">...</div></div>
        </div>

        <div class="glass-box" style="flex:1">
            <div class="box-header"><div class="box-title">Live Telemetry</div></div>
            <div class="charts-container">
                <div class="mini-chart"><div class="chart-header" style="color:#06b6d4; font-size:10px;">pH</div><div class="canvas-wrap"><canvas id="chartPH"></canvas></div></div>
                <div class="mini-chart"><div class="chart-header" style="color:#ff4d4d; font-size:10px;">TEMP</div><div class="canvas-wrap"><canvas id="chartTemp"></canvas></div></div>
                <div class="mini-chart"><div class="chart-header" style="color:#ffb400; font-size:10px;">TDS</div><div class="canvas-wrap"><canvas id="chartTDS"></canvas></div></div>
                <div class="mini-chart"><div class="chart-header" style="color:#b388ff; font-size:10px;">CLEAR</div><div class="canvas-wrap"><canvas id="chartTurb"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="panel-col">
        <div class="glass-box" style="border-color:rgba(255,77,77,0.2)">
            <div class="box-header"><div class="box-title" style="color:#ff8888">‚ö° Hardware Controls</div></div>
            <div class="control-row">
                <div style="font-size:13px; font-weight:bold">Master Power</div>
                <label class="switch"><input type="checkbox" id="btn-sys" onchange="blynk.set(PINS.sys, this.checked)"><span class="slider danger"></span></label>
            </div>
            <div class="control-row">
                <div style="font-size:13px; font-weight:bold">Buzzer Mute</div>
                <label class="switch"><input type="checkbox" id="btn-buz" onchange="blynk.set(PINS.buz, this.checked)"><span class="slider"></span></label>
            </div>
        </div>

        <div class="glass-box" style="flex:1; display:flex; flex-direction:column;">
            <div class="health-score-container">
                <div id="scoreCircle" class="score-circle">
                    <div id="healthScore" class="score-val">--</div>
                    <div class="score-label">Health</div>
                </div>
            </div>
            <div class="box-header">
                <div class="box-title">Smart Analysis</div>
                <div style="font-size:9px; color:#666" id="lastAnalysisTime">...</div>
            </div>
            <div id="analysis-feed" class="rec-feed"><div class="rec-card"><div class="rec-body">Stabilizing... (10s)</div></div></div>
        </div>
    </div>
</div>

<script>
// --- CONFIG ---
const BLYNK_TOKEN = "nYLD0xTd3NQ2RGu0BCZY9RK4etGQt76b"; 
const PINS = { ph:'v0', temp:'v1', tds:'v2', turb:'v3', sys:'v20', buz:'v21' };
const FISH_DB = {
    "Goldfish": { minT: 18, maxT: 23, minPH: 7.0, maxPH: 8.0, maxTDS: 400 },
    "Betta":    { minT: 24, maxT: 28, minPH: 6.5, maxPH: 7.5, maxTDS: 250 },
    "Guppy":    { minT: 22, maxT: 28, minPH: 7.0, maxPH: 8.2, maxTDS: 500 },
    "Discus":   { minT: 28, maxT: 31, minPH: 6.0, maxPH: 7.0, maxTDS: 150 },
    "Shrimp":   { minT: 20, maxT: 26, minPH: 6.5, maxPH: 7.5, maxTDS: 250 },
    "Tetra":    { minT: 21, maxT: 27, minPH: 6.0, maxPH: 7.5, maxTDS: 200 }
};

let app = { config: { limits: {}, elements: [], fish: [] }, charts: {}, online: false, interval: null, history: { ph:[], temp:[], tds:[], turb:[] }, lastAnalysis: 0 };

// --- PWA INSTALLATION ---
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  const btn = document.getElementById('pwaInstallBtn'); if(btn) btn.style.display = 'block';
});
async function installPWA() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  if(outcome === 'accepted') document.getElementById('pwaInstallBtn').style.display = 'none';
}

// --- HISTORY & DATA ---
const historyLog = {
    data: [],
    add: (ph, temp, tds, turb, score) => {
        const d = new Date();
        const entry = { 
            date: d.toLocaleDateString(undefined, {month:'short', day:'numeric'}),
            time: d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 
            ph: ph.toFixed(1), temp: temp.toFixed(1), tds: Math.floor(tds), turb: Math.floor(turb), score: score 
        };
        historyLog.data.unshift(entry);
        if(historyLog.data.length > 50) historyLog.data.pop(); // Increased to 50
        storage.saveLog(historyLog.data);
    },
    open: () => {
        const tb = document.getElementById('historyBody'); tb.innerHTML = '';
        const logs = storage.loadLog() || historyLog.data;
        if(!logs.length) tb.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">No data logged yet.</td></tr>';
        else logs.forEach(r => {
            let c='#00d26a'; if(r.score<80) c='#ffb400'; if(r.score<50) c='#ff4d4d';
            tb.innerHTML += `<tr>
                <td style="color:#666; font-size:10px;">${r.date}</td>
                <td>${r.time}</td><td>${r.ph}</td><td>${r.temp}</td><td>${r.tds}</td><td>${r.turb}%</td>
                <td style="color:${c}">${r.score}%</td>
            </tr>`;
        });
        document.getElementById('historyModal').classList.remove('hidden');
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.add('blur-ui'));
    },
    close: () => {
        document.getElementById('historyModal').classList.add('hidden');
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.remove('blur-ui'));
    },
    clear: () => {
        if(confirm("Clear all history logs?")) {
            historyLog.data = [];
            storage.saveLog([]);
            historyLog.open(); // refresh
        }
    }
};

const storage = {
    save: (d) => localStorage.setItem('aqua_conf_v5', JSON.stringify(d)),
    load: () => JSON.parse(localStorage.getItem('aqua_conf_v5')),
    saveLog: (d) => localStorage.setItem('aqua_log_v5', JSON.stringify(d)),
    loadLog: () => JSON.parse(localStorage.getItem('aqua_log_v5'))
};

// --- STARTUP & LOGIC ---
const appFlow = {
    start: () => {
        setTimeout(() => {
            document.getElementById('splashScreen').classList.add('fade-out');
            setTimeout(() => { document.getElementById('splashScreen').style.display='none'; document.getElementById('creditsModal').classList.remove('hidden'); }, 1000);
        }, 3000);
    },
    closeCredits: () => {
        document.getElementById('creditsModal').classList.add('hidden');
        const saved = storage.load();
        if(saved) { app.config=saved; appFlow.launch(); } else { document.getElementById('setupWizard').classList.remove('hidden'); wizard.next(1); }
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered')).catch(err => console.warn('SW Fail:', err));
        }
    },
    launch: () => {
        document.querySelectorAll('.blur-ui').forEach(e=>e.classList.remove('blur-ui'));
        initCharts(); setInterval(updateLoop, 2000);
    }
};

const blynk = {
    check: async () => {
        try {
            const r = await fetch(`https://blynk.cloud/external/api/isHardwareConnected?token=${BLYNK_TOKEN}`);
            const state = (await r.text()) === 'true';
            document.getElementById('connBadge').className = `status-badge ${state?'online':'offline'}`;
            document.getElementById('connText').style.display = "inline";
            document.getElementById('connText').innerText = state?"ON":"OFF";
        } catch(e){}
    },
    get: async (p) => { try { const r = await fetch(`https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&${p}`); if(!r.ok) return null; return parseFloat((await r.text()).replace(/[\[\]"]/g, '')); } catch(e){ return null; } },
    set: async (p, v) => { try { await fetch(`https://blynk.cloud/external/api/update?token=${BLYNK_TOKEN}&${p}=${v?1:0}`); } catch(e){} }
};

const wizard = {
    init: () => {
        const g = document.getElementById('fishGrid'); g.innerHTML = '';
        Object.keys(FISH_DB).forEach(f => { g.innerHTML += `<div><input type="checkbox" id="f_${f}" value="${f}" hidden><label for="f_${f}" class="opt-label">üêü ${f}</label></div>`; });
    },
    edit: () => {
        document.getElementById('setupWizard').classList.remove('hidden'); document.querySelectorAll('.blur-ui').forEach(e=>e.classList.add('blur-ui'));
        wizard.next(1);
        if(app.config.fish) {
            document.querySelectorAll('input').forEach(i=>i.checked=false);
            app.config.fish.forEach(f=> { if(document.getElementById(`f_${f}`)) document.getElementById(`f_${f}`).checked=true; });
            app.config.elements.forEach(e=> { const el=document.querySelector(`input[value="${e}"]`); if(el) el.checked=true; });
        }
    },
    next: (s) => { document.getElementById('step1').style.display=s===1?'block':'none'; document.getElementById('step2').style.display=s===2?'block':'none'; },
    finish: () => {
        const fish = Array.from(document.querySelectorAll('#step1 input:checked')).map(c=>c.value);
        const elem = Array.from(document.querySelectorAll('#step2 input:checked')).map(c=>c.value);
        if(!fish.length) fish.push("Guppy");
        let minT=0, maxT=100, minPH=0, maxPH=14, maxTDS=1000;
        fish.forEach(f => {
            const d = FISH_DB[f];
            if(d.minT > minT) minT=d.minT; if(d.maxT < maxT) maxT=d.maxT;
            if(d.minPH > minPH) minPH=d.minPH; if(d.maxPH < maxPH) maxPH=d.maxPH;
            if(d.maxTDS < maxTDS) maxTDS=d.maxTDS;
        });
        if(elem.includes("Driftwood") || elem.includes("Soil") || elem.includes("CO2")) { minPH-=0.3; maxPH-=0.2; }
        if(elem.includes("Rocks") || elem.includes("Coral")) { minPH+=0.3; maxPH+=0.3; maxTDS+=100; }
        app.config = { elements:elem, fish:fish, limits:{minT, maxT, minPH, maxPH, maxTDS} };
        storage.save(app.config);
        document.getElementById('setupWizard').classList.add('hidden');
        appFlow.launch();
    }
};

function initCharts() {
    const opts = { responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:true, grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#666', font:{size:8}}}} , elements:{point:{radius:0}, line:{tension:0.4, borderWidth:2}} };
    const make = (id, c) => new Chart(document.getElementById(id), {type:'line', data:{labels:[], datasets:[{data:[], borderColor:c, backgroundColor:c+'15', fill:true}]}, options:opts});
    if(app.charts.ph) { app.charts.ph.destroy(); app.charts.temp.destroy(); app.charts.tds.destroy(); app.charts.turb.destroy(); }
    app.charts.ph = make('chartPH', '#06b6d4'); app.charts.temp = make('chartTemp', '#ff4d4d'); app.charts.tds = make('chartTDS', '#ffb400'); app.charts.turb = make('chartTurb', '#b388ff');
}
function pushChart(k, v) { const c=app.charts[k]; c.data.labels.push(''); c.data.datasets[0].data.push(v); if(c.data.labels.length>15) { c.data.labels.shift(); c.data.datasets[0].data.shift(); } c.update('none'); }

async function updateLoop() {
    await blynk.check();
    const [ph, temp, tds, turb, sys, buz] = await Promise.all([
        blynk.get(PINS.ph), blynk.get(PINS.temp), blynk.get(PINS.tds), blynk.get(PINS.turb), blynk.get(PINS.sys), blynk.get(PINS.buz)
    ]);
    if(ph===null) return;
    document.getElementById('btn-sys').checked = (sys===1); document.getElementById('btn-buz').checked = (buz===1);
    const disp = (id, val, fix) => {
        const el=document.getElementById('val-'+id), pi=document.getElementById('status-'+id), ca=document.getElementById('card-'+id);
        if(val===-1 || val===-127) {
            el.innerText="--"; el.style.color="#666"; pi.innerText="NO SIGNAL"; pi.style.background="rgba(255,77,77,0.2)"; pi.style.color="var(--danger)"; ca.classList.add('error');
        } else {
            el.innerText=fix?Math.floor(val):val.toFixed(1); el.style.color="#fff"; ca.classList.remove('error'); pushChart(id, val); addToHistory(id, val);
        }
    };
    disp('ph', ph, false); disp('temp', temp, false); disp('tds', tds, true); disp('turb', turb, true);
    if(Date.now() - app.lastAnalysis > 10000) { analyzeStable(); app.lastAnalysis = Date.now(); }
}

function addToHistory(key, val) { if(val!==-1 && val!==-127) { app.history[key].push(val); if(app.history[key].length>30) app.history[key].shift(); } }
function getAvg(key) { const a=app.history[key]; return a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0; }

// === UPGRADED SMART ANALYTICS ENGINE (CONVERSATIONAL) ===
function analyzeStable() {
    const L = app.config.limits, E = app.config.elements;
    // Use average if available, otherwise fallback to last reading
    const ph = getAvg('ph') || 0, temp = getAvg('temp') || 0, tds = getAvg('tds') || 0, turb = getAvg('turb') || 0;
    
    let items = [], score = 100;

    const setPill=(id, cls, txt)=>{ 
        if(document.getElementById('val-'+id).innerText!=="--"){ 
            const el=document.getElementById('status-'+id); 
            el.className=`status-pill`; 
            el.style.background=cls==='good'?'rgba(0,255,157,0.1)':(cls==='warn'?'rgba(255,204,0,0.1)':'rgba(255,59,59,0.1)'); 
            el.style.color=cls==='good'?'var(--success)':(cls==='warn'?'var(--warning)':'var(--danger)'); 
            el.innerText=txt; 
        }
    };

    // 1. pH LOGIC (Conversational Context)
    if(ph < L.minPH) {
        let reason = "The water is becoming too acidic.";
        let fix = "Consider adding a pH buffer solution.";
        // Context Checks
        if (E.includes("Driftwood")) { reason = "It looks like tannins from your <b>Driftwood</b> are lowering the pH naturally."; fix = "You can remove some wood or perform a partial water change."; }
        if (E.includes("CO2")) { reason = "Your <b>CO2 injection</b> might be too high, causing acidity."; fix = "Reduce the CO2 bubble count immediately."; }
        
        items.push({type:'critical', title:`Low pH (${ph.toFixed(1)})`, rec:`${reason}<br><span class="rec-fix">RECOMMENDATION: ${fix}</span>`}); 
        setPill('ph','bad','ACIDIC'); score-=20;
    } 
    else if(ph > L.maxPH) {
        let reason = "The water is too alkaline (basic).";
        let fix = "You can add peat moss or almond leaves to the filter.";
        // Context Checks
        if (E.includes("Rocks") || E.includes("Coral")) { reason = "Your <b>Rocks or Coral</b> are likely leaching minerals into the water."; fix = "Consider removing some hardscape elements."; }
        if (E.includes("Plants")) { reason = "Rapid plant photosynthesis might be raising the pH."; fix = "Try reducing the light period by 1 hour."; }

        items.push({type:'warning', title:`High pH (${ph.toFixed(1)})`, rec:`${reason}<br><span class="rec-fix">RECOMMENDATION: ${fix}</span>`}); 
        setPill('ph','warn','ALKALINE'); score-=10;
    } 
    else setPill('ph','good','OPTIMAL');

    // 2. TEMP LOGIC
    if(temp < L.minT) { 
        items.push({type:'critical', title:`Low Temp (${temp.toFixed(1)}¬∞C)`, rec:`The water is too cold for your livestock.<br><span class="rec-fix">ACTION: Check if your heater is plugged in or set correctly.</span>`}); 
        setPill('temp','bad','COLD'); score-=30; 
    } 
    else if(temp > L.maxT) { 
        items.push({type:'critical', title:`High Temp (${temp.toFixed(1)}¬∞C)`, rec:`Risk of overheating detected.<br><span class="rec-fix">ACTION: Turn off tank lights & float ice bottles to cool it down.</span>`}); 
        setPill('temp','bad','HOT'); score-=30; 
    } 
    else setPill('temp','good','OPTIMAL');

    // 3. CLARITY LOGIC
    if(turb < 20) { 
        // Check if the user has Soil
        if(E.includes("Soil")) { 
            items.push({type:'warning', title:'Water Haze', rec:`This haze is likely dust from your <b>Aqua Soil</b>.<br><span class="rec-fix">NOTE: Do nothing. It will settle naturally in 24 hours.</span>`}); 
            setPill('turb','warn','HAZE'); score-=5; 
        } else { 
            items.push({type:'critical', title:'Low Clarity', rec:`The water is unusually cloudy or dirty.<br><span class="rec-fix">ACTION: Check your filter flow or look for a bacterial bloom.</span>`}); 
            setPill('turb','bad','DIRTY'); score-=15; 
        } 
    } else setPill('turb','good','CLEAR');

    // 4. TDS LOGIC
    if(tds > L.maxTDS) { 
        let reason = "High concentration of dissolved solids.";
        if (E.includes("Coral")) reason = "Your <b>Crushed Coral</b> substrate is dissolving rapidly.";
        
        items.push({type:'warning', title:'High TDS', rec:`${reason}<br><span class="rec-fix">ACTION: Perform a 20% water change to dilute it.</span>`}); 
        setPill('tds','warn','HIGH'); score-=10; 
    } else setPill('tds','good','OPTIMAL');

    // RENDER
    const feed=document.getElementById('analysis-feed');
    if(!items.length) feed.innerHTML=`<div class="rec-card good"><div class="rec-header">‚úÖ System Stable</div><div class="rec-body">All water parameters match the specific needs of your selected livestock.</div></div>`;
    else feed.innerHTML=items.map(i=>`<div class="rec-card ${i.type}"><div class="rec-header"><span>${i.type==='critical'?'üö®':'‚ö†Ô∏è'} ${i.title}</span></div><div class="rec-body">${i.rec}</div></div>`).join('');

    if(score<0) score=0; const el=document.getElementById('healthScore'), ring=document.getElementById('scoreCircle');
    el.innerText=Math.floor(score)+"%";
    let c='var(--success)'; if(score<80) c='var(--warning)'; if(score<50) c='var(--danger)';
    ring.style.borderColor=c; el.style.color=c;
    document.getElementById('lastAnalysisTime').innerText="Analysis: "+new Date().toLocaleTimeString();
    
    historyLog.add(ph, temp, tds, turb, score);
}

window.onload = () => { wizard.init(); appFlow.start(); };
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.log("SW registration failed:", err));
}
</script>


</body>

</html>

